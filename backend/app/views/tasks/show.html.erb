<div class="space-y-6">
  <div class="flex justify-between items-center">
    <div>
      <h2 class="text-3xl font-bold text-gray-900"><%= @task.title %></h2>
      <p class="mt-1 text-sm text-gray-500">
        <%= @task.task_type.titleize %> • Created by <%= @task.created_by.email %>
      </p>
    </div>
    <div class="flex space-x-3">
      <%= link_to "Edit", edit_senior_task_path(@senior, @task), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
      <%= link_to "← Back to Tasks", senior_tasks_path(@senior), class: "text-blue-600 hover:text-blue-800" %>
    </div>
  </div>

  <!-- Task Details -->
  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
      <div>
        <h3 class="text-lg leading-6 font-medium text-gray-900">Task Details</h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">Complete information about this task</p>
      </div>
      <div class="flex space-x-2">
        <!-- Status Badge -->
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
          <%= case @task.status
              when 'completed' then 'bg-green-100 text-green-800'
              when 'in_progress' then 'bg-blue-100 text-blue-800'
              when 'assigned' then 'bg-purple-100 text-purple-800'
              when 'cancelled' then 'bg-gray-100 text-gray-800'
              else 'bg-yellow-100 text-yellow-800'
              end %>">
          <%= @task.status.titleize.gsub('_', ' ') %>
        </span>

        <!-- Priority Badge -->
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
          <%= case @task.priority
              when 'urgent' then 'bg-red-100 text-red-800'
              when 'high' then 'bg-orange-100 text-orange-800'
              when 'medium' then 'bg-yellow-100 text-yellow-800'
              else 'bg-gray-100 text-gray-800'
              end %>">
          <%= @task.priority.titleize %> Priority
        </span>
      </div>
    </div>
    <div class="border-t border-gray-200">
      <dl>
        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Scheduled for</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <%= @task.scheduled_at.strftime("%A, %B %d, %Y at %I:%M %p") %>
            <% if @task.duration_minutes.present? %>
              <span class="text-gray-500">(~<%= @task.duration_minutes %> minutes)</span>
            <% end %>
          </dd>
        </div>

        <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Assigned to</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <% if @task.assigned_to %>
              <%= @task.assigned_to.email %>
              <% if @task.assigned_to != current_user && @senior.caregivers.count > 1 %>
                <%= form_with url: assign_senior_task_path(@senior, @task), method: :post, class: "inline-block ml-2" do |f| %>
                  <%= f.select :caregiver_id, 
                    options_for_select(@senior.caregivers.map { |c| [c.email, c.id] }, @task.assigned_to_id),
                    {},
                    class: "inline-block rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs",
                    onchange: "this.form.submit()" %>
                <% end %>
              <% end %>
            <% else %>
              <span class="text-gray-400 italic">Unassigned</span>
              <% if @senior.caregivers.any? %>
                <%= form_with url: assign_senior_task_path(@senior, @task), method: :post, class: "inline-block ml-2" do |f| %>
                  <%= f.select :caregiver_id, 
                    options_for_select([["Assign to...", ""]] + @senior.caregivers.map { |c| [c.email, c.id] }),
                    {},
                    class: "inline-block rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs",
                    onchange: "if(this.value) this.form.submit()" %>
                <% end %>
              <% end %>
            <% end %>
          </dd>
        </div>

        <% if @task.location.present? %>
          <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Location</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @task.location %></dd>
          </div>
        <% end %>

        <% if @task.description.present? %>
          <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Description</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 whitespace-pre-wrap"><%= @task.description %></dd>
          </div>
        <% end %>

        <% if @task.notes.present? %>
          <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Notes/Instructions</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 whitespace-pre-wrap"><%= @task.notes %></dd>
          </div>
        <% end %>

        <% if @task.completed_at.present? %>
          <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Completed at</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
              <%= @task.completed_at.strftime("%A, %B %d, %Y at %I:%M %p") %>
            </dd>
          </div>
        <% end %>
      </dl>
    </div>
  </div>

  <!-- Quick Actions -->
  <% if @task.status != "completed" && @task.status != "cancelled" %>
    <div class="bg-white shadow sm:rounded-lg p-4">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-medium text-gray-900">Quick Actions</h3>
        <div class="flex space-x-3">
          <% if @task.status == "pending" || @task.status == "assigned" %>
            <%= button_to "Start Task", senior_task_path(@senior, @task), method: :patch, params: { task: { status: :in_progress } }, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700" %>
          <% end %>
          
          <% if @task.status == "in_progress" || @task.status == "assigned" %>
            <%= button_to "Mark Complete", complete_senior_task_path(@senior, @task), method: :post, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" %>
          <% end %>
          
          <%= button_to "Cancel Task", senior_task_path(@senior, @task), method: :patch, params: { task: { status: :cancelled } }, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50", data: { confirm: "Are you sure you want to cancel this task?" } %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Comments Section -->
  <div class="bg-white shadow sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Comments</h3>
      
      <!-- Comment Form -->
      <%= form_with model: [@senior, @task, TaskComment.new], url: senior_task_comments_path(@senior, @task), class: "mb-6" do |f| %>
        <div>
          <%= f.label :content, "Add a comment", class: "block text-sm font-medium text-gray-700" %>
          <%= f.text_area :content, rows: 3, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", placeholder: "Share updates, notes, or questions..." %>
        </div>
        <div class="mt-3 flex justify-end">
          <%= f.submit "Add Comment", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700" %>
        </div>
      <% end %>

      <!-- Comments List -->
      <% if @comments.any? %>
        <div class="space-y-4">
          <% @comments.each do |comment| %>
            <div class="border-l-4 border-gray-200 pl-4 py-2">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900"><%= comment.user.email %></p>
                  <p class="mt-1 text-sm text-gray-700 whitespace-pre-wrap"><%= comment.content %></p>
                  <p class="mt-1 text-xs text-gray-500"><%= time_ago_in_words(comment.created_at) %> ago</p>
                </div>
                <% if comment.user == current_user %>
                  <%= button_to "Delete", senior_task_comment_path(@senior, @task, comment), method: :delete, class: "text-xs text-red-600 hover:text-red-800", data: { confirm: "Are you sure?" } %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-gray-500 italic">No comments yet. Be the first to add one!</p>
      <% end %>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="bg-white shadow sm:rounded-lg border-2 border-red-200">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg leading-6 font-medium text-red-900">Danger Zone</h3>
      <div class="mt-2 max-w-xl text-sm text-gray-500">
        <p>Once you delete a task, there is no going back. Please be certain.</p>
      </div>
      <div class="mt-5">
        <%= button_to "Delete Task", senior_task_path(@senior, @task), method: :delete, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700", data: { confirm: "Are you sure you want to delete this task? This action cannot be undone." } %>
      </div>
    </div>
  </div>
</div>
